# Motion Profiles

## Motion Profiles are a way to smoothly control a mechanism by combining PID and FF control

As the [Controls](3.1_ControlsIntro.md) article covered, it is often beneficial to combine feedforward and feedback (for our use, usually PID) control.
When we want to control the _position_ of a mechanism, however, we're limited by the fact that feedforward for a DC motor (such as a Kraken X60) controls _velocity_.
It's unrealistic to expect a mechanism to instantly get to a desired position, because it takes time to accelerate to the velocity needed to get to that position.

A motion profile accounts for this by interpolating (calculating intermediate positions) to target *between* a starting position and a setpoint position.
There are various types of motion profiles, but the one we use most often is called a _trapezoidal motion profile_.

![An illustration of a trapezoidal motion profile](../../Assets/MotionProfileExample.webp)

This graph shows a motion profile over time.
The blue line is the position of the controller, the black line is the velocity of the controller and the red line is acceleration.

You can see the 3 phases of the profile, with an accelerating phase at the start (the first leg of the trapezoid), a cruising phase through most of the profile (the top base), and a deaccelerating phase at the end (the second leg).
During the acceleration phase, the velocity increases, so the position gradually increases as well.
During the cruising phase, the acceleration is 0 so the velocity isn't changing, and the position is still increasing.
Then, during the deacceleration phase, the velocity decreases back down to 0, so the position doesn't change (because it's hopefully at the target position).

So, for each point on this graph, the motor uses the corresponding velocity setpoint.
That means the position line smoothly starts and stops, resulting in clean movement of the mechanism which minimizes wasted effort.

The real advantage of this is that now we have both a position and velocity setpoint at any given time, which means that the PID controller can adjust for disturbances in position while the feedforward controller can provide the majority of the control effort to get to the setpoint.

### Resources

- [What is a motion profile?](https://www.motioncontroltips.com/what-is-a-motion-profile/)
- [WPILib TrapezoidProfile docs](https://docs.wpilib.org/en/stable/docs/software/advanced-controls/controllers/trapezoidal-profiles.html)
- [WPILib ProfiledPIDController docs](https://docs.wpilib.org/en/stable/docs/software/advanced-controls/controllers/profiled-pidcontroller.html)

### Examples

- Our 2023 elevator uses motion profiling.

### Exercises

- Add a simulated elevator to your kitbot example code and use a motion profile to control it!
  - Follow the AdvantageKit structure described [here](Docs\2_Architecture\2.7_AKitStructureReference.md) to create an `ElevatorSubsystem`, `ElevatorIO`, and `ElevatorIOSim`.
    (Don't worry about `ElevatorIOReal` for now.)
    You can also reference the drivetrain walkthrough if you get stuck on some of the specifics of adding `TalonFX`s.
  - In `ElevatorIOSim`, use WPILib's `ElevatorSim` class.
    - It'll ask you for some parameters related to the physical setup of your specific (hypothetical) elevator.
      Ask a software lead for what set of numbers you should use and what they mean.  
  - Create a `ProfiledPIDController` and `ElevatorFeedforward` and use them to calculate the voltage you need to set for the elevator.

### Notes

- Motion profiling is primarily used for position-controlled mechanisms like elevators and arms.
  It can also be used on velocity controlled mechanisms, although it provides less of a benefit.
- If a CTRE control requests has `MotionMagic` in the name, that just means it's running a motion profile on the motor controller, so we don't need to generate it directly.